name: DennÃ­ CSFD Update

on:
  # KaÅ¾dÃ½ den v 2:00 UTC (3:00 CET) - rychlÃ¡ kontrola novÃ½ch poloÅ¾ek
  schedule:
    - cron: "0 2 * * *"
  
  # ManuÃ¡lnÃ­ spuÅ¡tÄ›nÃ­
  workflow_dispatch:
    inputs:
      mode:
        description: 'ReÅ¾im spuÅ¡tÄ›nÃ­'
        required: true
        default: 'incremental'
        type: choice
        options:
        - 'incremental'     # RychlÃ¡ kontrola novÃ½ch poloÅ¾ek (~2-5 min)
        - 'full-check'      # Kontrola vÃ­ce strÃ¡nek (~10-15 min)
        - 'force-full'      # Vynutit plnÃ½ scraper (3+ hodiny)
        - 'test'            # Test reÅ¾im (~1 min)
      verbose:
        description: 'DetailnÃ­ logovÃ¡nÃ­'
        required: false
        default: true
        type: boolean

jobs:
  daily-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3) Install dependencies
      - name: Install dependencies
        run: |
          npm i
          npx playwright install --with-deps chromium

      # 4) SpuÅ¡tÄ›nÃ­ podle reÅ¾imu
      - name: Run daily scraper
        run: |
          VERBOSE_FLAG=""
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            VERBOSE_FLAG="--verbose"
          fi
          
          case "${{ github.event.inputs.mode || 'incremental' }}" in
            "incremental")
              echo "ðŸš€ DennÃ­ inkrementÃ¡lnÃ­ update - kontrola novÃ½ch poloÅ¾ek"
              node incremental_scraper.mjs
              ;;
            "full-check")
              echo "ðŸ” RozÅ¡Ã­Å™enÃ¡ kontrola - vÃ­ce strÃ¡nek"
              # UpravÃ­me konfiguraci pro vÃ­ce strÃ¡nek
              node -e "
                const fs = require('fs');
                let content = fs.readFileSync('incremental_scraper.mjs', 'utf8');
                content = content.replace('maxPagesToCheck: 5', 'maxPagesToCheck: 10');
                content = content.replace('maxNewItems: 50', 'maxNewItems: 100');
                fs.writeFileSync('incremental_scraper_temp.mjs', content);
              "
              node incremental_scraper_temp.mjs
              rm incremental_scraper_temp.mjs
              ;;
            "force-full")
              echo "ðŸ­ VynucenÃ­ plnÃ©ho scraperu - 3+ hodiny"
              node scrape_csfd.mjs --verbose
              ;;
            "test")
              echo "ðŸ§ª Test reÅ¾im - rychlÃ½ test"
              node test_incremental.mjs
              ;;
            *)
              echo "âŒ NeznÃ¡mÃ½ reÅ¾im: ${{ github.event.inputs.mode }}"
              exit 1
              ;;
          esac

      # 5) Komprese dat (pouze pokud byly zmÄ›ny)
      - name: Compress data if changed
        if: success()
        run: |
          if [ -f "data/new_items.json" ] && [ -s "data/new_items.json" ]; then
            echo "ðŸ—œï¸ Komprimuji aktualizovanÃ¡ data..."
            node build_compress.mjs
            echo "âœ… Komprese dokonÄena"
          else
            echo "â„¹ï¸ Å½Ã¡dnÃ© novÃ© poloÅ¾ky - komprese pÅ™eskoÄena"
          fi

      # 6) Commit zmÄ›n
      - name: Commit changes
        if: success()
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # PÅ™idÃ¡nÃ­ vÅ¡ech zmÄ›nÄ›nÃ½ch souborÅ¯
          git add data/ || true
          
          # Kontrola, zda jsou nÄ›jakÃ© zmÄ›ny
          if ! git diff --cached --quiet; then
            # ZÃ­skÃ¡nÃ­ informacÃ­ o novÃ½ch poloÅ¾kÃ¡ch
            NEW_ITEMS_COUNT=0
            if [ -f "data/new_items.json" ]; then
              NEW_ITEMS_COUNT=$(node -e "try { console.log(JSON.parse(require('fs').readFileSync('data/new_items.json', 'utf8')).length); } catch { console.log(0); }")
            fi
            
            if [ "$NEW_ITEMS_COUNT" -gt 0 ]; then
              git commit -m "ðŸ†• DennÃ­ update: PÅ™idÃ¡no $NEW_ITEMS_COUNT novÃ½ch poloÅ¾ek [skip ci]"
            else
              git commit -m "ðŸ”„ DennÃ­ update: Å½Ã¡dnÃ© novÃ© poloÅ¾ky [skip ci]"
            fi
            
            git push
            echo "âœ… ZmÄ›ny commitnuty a pushnuty"
          else
            echo "â„¹ï¸ Å½Ã¡dnÃ© zmÄ›ny k commitnutÃ­"
          fi

      # 7) Aktualizace schedule podle aktivity
      - name: Update smart schedule
        if: success()
        run: |
          echo "ðŸ”„ Aktualizuji schedule podle aktivity..."
          node smart_scheduler.mjs --update || echo "Schedule update failed, continuing..."

      # 8) Upload debug artifacts
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-debug-${{ github.run_number }}
          path: |
            data/new_items.json
            data/incremental_state.json
            data/schedule_config.json
            data/*_backup_*.json
          retention-days: 7

      # 9) Summary
      - name: Daily Update Summary
        if: always()
        run: |
          echo "## ðŸ“Š DennÃ­ CSFD Update - VÃ½sledek" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/incremental_state.json" ]; then
            NEW_ITEMS=$(node -e "try { const state = JSON.parse(require('fs').readFileSync('data/incremental_state.json', 'utf8')); console.log(state.newItemsFound || 0); } catch { console.log(0); }")
            TOTAL_ITEMS=$(node -e "try { const state = JSON.parse(require('fs').readFileSync('data/incremental_state.json', 'utf8')); console.log(state.totalItems || 0); } catch { console.log(0); }")
            PAGES_CHECKED=$(node -e "try { const state = JSON.parse(require('fs').readFileSync('data/incremental_state.json', 'utf8')); console.log(state.pagesChecked || 0); } catch { console.log(0); }")
            
            echo "- **NovÃ© poloÅ¾ky:** $NEW_ITEMS" >> $GITHUB_STEP_SUMMARY
            echo "- **Celkem poloÅ¾ek:** $TOTAL_ITEMS" >> $GITHUB_STEP_SUMMARY
            echo "- **ZkontrolovanÃ© strÃ¡nky:** $PAGES_CHECKED" >> $GITHUB_STEP_SUMMARY
            echo "- **ÄŒas bÄ›hu:** $(date)" >> $GITHUB_STEP_SUMMARY
            
            if [ "$NEW_ITEMS" -gt 0 ]; then
              echo "- **Status:** âœ… Nalezeny novÃ© poloÅ¾ky" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Status:** â„¹ï¸ Å½Ã¡dnÃ© novÃ© poloÅ¾ky" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Stav:** âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ stavu" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Soubory" >> $GITHUB_STEP_SUMMARY
          echo "- \`data/csfd_ratings.json\` - HlavnÃ­ dataset" >> $GITHUB_STEP_SUMMARY
          echo "- \`data/new_items.json\` - NovÃ© poloÅ¾ky z tohoto bÄ›hu" >> $GITHUB_STEP_SUMMARY
          echo "- \`data/incremental_state.json\` - Stav poslednÃ­ho bÄ›hu" >> $GITHUB_STEP_SUMMARY
          echo "- \`data/schedule_config.json\` - AktuÃ¡lnÃ­ schedule konfigurace" >> $GITHUB_STEP_SUMMARY
